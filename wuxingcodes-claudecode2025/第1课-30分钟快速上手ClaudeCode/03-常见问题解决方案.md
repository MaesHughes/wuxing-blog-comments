# ClaudeCode常见问题解决方案

## 问题诊断命令

### Windows诊断工具

脚本位置：[`scripts/diagnose-windows.bat`](scripts/diagnose-windows.bat)

### 功能说明
- 检查Node.js和npm版本
- 验证ClaudeCode安装状态
- 检查环境变量配置
- 测试API连接

### 使用方法
```batch
# 双击运行或在CMD中执行
scripts\diagnose-windows.bat
```

### macOS/Linux诊断工具

脚本位置：[`scripts/diagnose-unix.sh`](scripts/diagnose-unix.sh)

### 使用方法
```bash
# 赋予执行权限并运行
chmod +x scripts/diagnose-unix.sh
./scripts/diagnose-unix.sh
```

## 常见问题及解决方案

### 1. command not found 错误

#### Windows解决方案

脚本位置：[`scripts/fix-command-not-found.bat`](scripts/fix-command-not-found.bat)

### 功能说明
- 自动查找npm全局路径
- 将npm路径添加到系统PATH
- 刷新环境变量

#### macOS/Linux解决方案

脚本位置：[`scripts/fix-command-not-found-unix.sh`](scripts/fix-command-not-found-unix.sh)

### 功能说明
- 自动检测shell类型（zsh/bash）
- 添加npm路径到shell配置
- 创建系统符号链接（如权限允许）

### 2. 权限错误 (EACCES)

#### macOS/Linux解决方案

脚本位置：[`scripts/fix-eacces-unix.sh`](scripts/fix-eacces-unix.sh)

### 功能说明
- 修复npm目录权限
- 提供nvm安装选项
- 配置用户级npm目录

#### Windows PowerShell解决方案

脚本位置：[`scripts/fix-eacces-windows.ps1`](scripts/fix-eacces-windows.ps1)

### 使用方法
```powershell
# 以管理员身份运行PowerShell
.\scripts\fix-eacces-windows.ps1
```

### 3. 网络连接问题

#### 代理环境配置

脚本位置：[`scripts/setup-proxy.sh`](scripts/setup-proxy.sh)

### 功能说明
- 交互式配置代理设置
- 同时设置npm和环境变量代理
- 支持取消代理配置

#### 国内镜像配置

脚本位置：[`scripts/fix-network.sh`](scripts/fix-network.sh)

### 功能说明
- 快速切换到淘宝镜像源
- 验证镜像设置成功
- 提供恢复官方源的命令

### 4. API密钥问题

#### API密钥验证和修复

脚本位置：[`scripts/verify-api-key.sh`](scripts/verify-api-key.sh)

### 功能说明
- 验证API密钥格式
- 测试API连接有效性
- 提供设置指引

### 使用方法
```bash
# 确保已设置API密钥
export ANTHROPIC_API_KEY="your-api-key"

# 运行验证脚本
./scripts/verify-api-key.sh
```

### 5. API认证错误 (401)

#### 错误现象

```
API Error: 401 {"type":"error","error":{"type":"authentication_error","message":"Token not found or expired"}}
```

#### 原因分析
- API密钥已过期
- API密钥输入错误
- 环境变量未正确设置
- 账户余额不足或被限制

#### 解决步骤

1. **验证当前API密钥**：
   ```bash
   # Windows
   echo %ANTHROPIC_API_KEY%

   # macOS/Linux
   echo $ANTHROPIC_API_KEY
   ```

2. **重新生成API密钥**：
   - 访问 [Anthropic Console](https://console.anthropic.com)
   - 登录您的账户
   - 进入 "API Keys" 页面
   - 删除旧密钥（如果需要）
   - 创建新的API密钥
   - 复制新密钥（注意：密钥只显示一次）

3. **更新环境变量**：

   **Windows**：
   ```cmd
   # 临时设置（当前会话有效）
   set ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxx

   # 永久设置
   setx ANTHROPIC_API_KEY "sk-ant-api03-xxxxxxxxx"
   # 重启命令行使设置生效
   ```

   **macOS/Linux**：
   ```bash
   # 临时设置（当前会话有效）
   export ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxx

   # 永久设置（添加到 ~/.bashrc 或 ~/.zshrc）
   echo 'export ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxx' >> ~/.bashrc
   source ~/.bashrc
   ```

4. **验证新API密钥**：
   ```bash
   # 测试API连接
   claudecode "Hello, can you see this message?"
   ```

5. **检查账户状态**：
   - 确认账户有足够的余额
   - 检查是否有使用限制
   - 确认API密钥权限正确

#### 常见问题

Q: **找不到 /login 命令怎么办？**
A: ClaudeCode没有/login命令。需要通过环境变量设置API密钥。

Q: **API密钥设置后仍然401错误？**
A: 尝试以下步骤：
1. 重启终端/命令行
2. 检查密钥是否正确复制（包括sk-ant前缀）
3. 确认没有额外的空格或换行符

Q: **如何安全地管理API密钥？**
A: 最佳实践：
- 不要在代码中硬编码API密钥
- 使用环境变量或配置管理工具
- 定期轮换API密钥
- 不要在版本控制中提交API密钥

### 6. 版本冲突问题

#### Node.js版本管理

脚本位置：[`scripts/manage-nodejs.sh`](scripts/manage-nodejs.sh)

### 功能说明
- 检查当前Node.js版本
- 使用nvm管理多个版本
- 自动安装Node.js 18并设为默认

### 6. 完全清理和重置

#### Unix/Linux清理脚本

脚本位置：[`scripts/cleanup-unix.sh`](scripts/cleanup-unix.sh)

### 功能说明
- 完全卸载ClaudeCode
- 清理所有配置文件和缓存
- 可选清理环境变量

#### Windows清理脚本

脚本位置：[`scripts/cleanup-windows.bat`](scripts/cleanup-windows.bat)

### 功能说明
- 停止所有ClaudeCode进程
- 卸载npm包和清理配置
- 清理环境变量

## 性能优化配置

### ClaudeCode性能优化配置

配置文件位置：[`configs/config-performance.json`](configs/config-performance.json)

### 主要优化项
- 使用最新模型 `claude-3-5-sonnet-20241022`
- 增大token限制到8192
- 启用2GB缓存，48小时TTL
- 启用内容压缩
- 并行处理支持

### 使用方法
```bash
# 应用性能配置
cp configs/config-performance.json ~/.claude/config.json
```

## 故障排除检查清单

### 完整检查清单

```markdown
## ClaudeCode故障排除检查清单

### ✅ 基础检查
- [ ] Node.js版本 >= 18.0.0
- [ ] npm版本正常
- [ ] 网络连接正常
- [ ] 有足够的磁盘空间 (> 1GB)
- [ ] 有足够的内存 (> 2GB)

### ✅ 安装检查
- [ ] ClaudeCode已全局安装
- [ ] claude命令可在PATH中找到
- [ ] 版本号显示正常

### ✅ 配置检查
- [ ] API密钥已设置 (sk-ant-xxx)
- [ ] API密钥格式正确
- [ ] 环境变量生效
- [ ] 配置文件存在且格式正确

### ✅ 功能检查
- [ ] 可以连接到API
- [ ] 基础对话功能正常
- [ ] 文件读取功能正常
- [ ] 文件编辑功能正常

### ✅ IDE集成检查
- [ ] VS Code扩展已安装（如使用）
- [ ] 扩展配置正确
- [ ] 可以在编辑器中使用
```

## 快速解决指引

### 根据错误类型选择解决方案

| 错误类型 | 推荐脚本/解决方案 | 说明 |
|---------|---------|------|
| `command not found` | `fix-command-not-found-*` | PATH路径问题 |
| `EACCES` 权限错误 | `fix-eacces-*` | npm权限问题 |
| 网络超时/连接失败 | `fix-network.sh` | 镜像源问题 |
| API连接失败 | `verify-api-key.sh` | API密钥问题 |
| **401认证错误** | **重新设置API密钥** | **查看第5节详细步骤** |
| 版本不兼容 | `manage-nodejs.sh` | Node.js版本问题 |
| 需要完全重装 | `cleanup-*` | 清理后重装 |

### 使用建议

1. **先运行诊断脚本**：确定问题根源
2. **查看错误日志**：`~/.claude/logs/claude.log`
3. **逐步尝试解决方案**：从最简单的方法开始
4. **保持耐心**：某些问题可能需要多次尝试

## 获取更多帮助

如果以上解决方案无法解决您的问题：

1. **查看官方文档**：https://docs.anthropic.com
2. **GitHub Issues**：https://github.com/anthropics/claude-code
3. **社区论坛**：https://community.anthropic.com

## 注意事项

- 所有脚本都已更新为使用最新的模型版本 `claude-3-5-haiku-20241022`
- 运行脚本前请确保已备份重要数据
- Windows用户可能需要以管理员身份运行某些脚本
- macOS/Linux用户可能需要sudo权限进行某些操作