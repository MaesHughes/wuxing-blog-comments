# å®‰å…¨é…ç½®æœ€ä½³å®è·µ

## æ¦‚è¿°

ClaudeCodeæä¾›äº†å¤šå±‚å®‰å…¨ä¿æŠ¤æœºåˆ¶ï¼ŒåŒ…æ‹¬æƒé™æ§åˆ¶ã€æ²™ç›’éš”ç¦»ã€è®¿é—®å®¡è®¡ç­‰ã€‚åˆç†é…ç½®è¿™äº›å®‰å…¨æªæ–½å¯ä»¥ä¿æŠ¤æ‚¨çš„ä»£ç å’Œæ•°æ®å®‰å…¨ã€‚

## æƒé™æ§åˆ¶æ¶æ„

### æƒé™åŸºç¡€

ClaudeCodeé‡‡ç”¨é»˜è®¤åªè¯»æƒé™ç­–ç•¥ï¼Œæ‰€æœ‰å†™æ“ä½œå’Œç³»ç»Ÿå‘½ä»¤éƒ½éœ€è¦æ˜ç¡®æˆæƒã€‚

*ï¼ˆå¼•ç”¨æ¥æºï¼šå®˜æ–¹å®‰å…¨é…ç½®æ–‡æ¡£ - æƒé™æ¶æ„éƒ¨åˆ†ï¼‰*

### åŸºç¡€æƒé™é…ç½®

```json
{
  "permissions": {
    "allowed_dirs": [
      "./src",
      "./tests",
      "./docs",
      "./config"
    ],
    "denied_dirs": [
      "~/.ssh",
      "/etc",
      "~/.config",
      "~/.aws"
    ],
    "allowed_commands": [
      "git",
      "npm",
      "node",
      "python",
      "pytest",
      "eslint"
    ],
    "denied_commands": [
      "sudo",
      "su",
      "rm -rf",
      "chmod 777",
      "dd if=",
      "mkfs"
    ],
    "require_confirmation": [
      "git push",
      "npm publish",
      "docker push"
    ]
  }
}
```

### ç»†ç²’åº¦æƒé™æ§åˆ¶

```json
{
  "permissions": {
    "file_operations": {
      "read": {
        "allowed": true,
        "exceptions": ["~/.ssh/id_rsa", "*.pem"]
      },
      "write": {
        "allowed": true,
        "require_confirmation": ["*.json", "*.yml", "*.yaml"]
      },
      "delete": {
        "allowed": true,
        "require_confirmation": true,
        "protected_patterns": ["*.backup", "*.orig"]
      }
    },
    "command_execution": {
      "allowed_patterns": [
        "git *",
        "npm *",
        "python *",
        "node *"
      ],
      "dangerous_patterns": [
        "rm * -rf",
        "chmod 777 *",
        "sudo *",
        "su *",
        "dd *",
        "mkfs *"
      ]
    }
  }
}
```

## æ²™ç›’å®‰å…¨é…ç½®

### å¯ç”¨æ²™ç›’æ¨¡å¼

æ²™ç›’æ¨¡å¼æä¾›æ–‡ä»¶ç³»ç»Ÿå’Œç½‘ç»œéš”ç¦»ï¼š

```bash
# å¯ç”¨æ²™ç›’
claude /sandbox

# æŸ¥çœ‹æ²™ç›’çŠ¶æ€
claude /sandbox status
```

*ï¼ˆå¼•ç”¨æ¥æºï¼šå®˜æ–¹å®‰å…¨é…ç½®æ–‡æ¡£ - æ²™ç›’bashå·¥å…·éƒ¨åˆ†ï¼‰*

### æ²™ç›’é…ç½®é€‰é¡¹

```json
{
  "sandbox": {
    "enabled": true,
    "filesystem": {
      "boundaries": [
        "/workspace",
        "/tmp",
        "./src"
      ],
      "read_only": [
        "/usr",
        "/lib",
        "/bin"
      ]
    },
    "network": {
      "allowed_domains": [
        "api.github.com",
        "registry.npmjs.org",
        "pypi.org",
        "company-api.com"
      ],
      "allowed_ports": [80, 443, 8080],
      "blocked_domains": [
        "*.malicious.com",
        "suspicious-site.net"
      ]
    },
    "resource_limits": {
      "max_memory": "1GB",
      "max_cpu_time": 60,
      "max_processes": 10
    }
  }
}
```

### ç½‘ç»œè®¿é—®æ§åˆ¶

```json
{
  "network": {
    "mode": "restricted",
    "proxy": {
      "http": "http://proxy.company.com:8080",
      "https": "https://proxy.company.com:8080"
    },
    "firewall_rules": [
      {
        "action": "allow",
        "domain": "api.github.com",
        "port": 443
      },
      {
        "action": "deny",
        "pattern": "*malicious*"
      }
    ]
  }
}
```

## æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

### APIå¯†é’¥ç®¡ç†

ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼š

```bash
# .envæ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
ANTHROPIC_API_KEY=your_api_key_here
DATABASE_URL=postgresql://user:pass@localhost/db
GITHUB_TOKEN=your_github_token

# è®¾ç½®æƒé™
chmod 600 .env
```

### æ•æ„Ÿæ–‡ä»¶ä¿æŠ¤

```json
{
  "security": {
    "sensitive_patterns": [
      "*.key",
      "*.pem",
      "*.p12",
      "id_rsa",
      ".env*",
      "*secret*",
      "*password*"
    ],
    "sensitive_actions": [
      "read_sensitive_file",
      "write_sensitive_file",
      "expose_credential"
    ]
  }
}
```

### è®¿é—®æ—¥å¿—è®°å½•

```json
{
  "audit": {
    "enabled": true,
    "log_level": "info",
    "log_file": "~/.claude/audit.log",
    "rotate": {
      "max_size": "100MB",
      "max_files": 10
    },
    "events": [
      "file_access",
      "command_execution",
      "permission_denied",
      "api_call"
    ]
  }
}
```

## æç¤ºæ³¨å…¥é˜²æŠ¤

### å†…ç½®ä¿æŠ¤æœºåˆ¶

ClaudeCodeæä¾›å¤šå±‚é˜²æŠ¤é˜²æ­¢æç¤ºæ³¨å…¥æ”»å‡»ï¼š

*ï¼ˆå¼•ç”¨æ¥æºï¼šå®˜æ–¹å®‰å…¨é…ç½®æ–‡æ¡£ - é˜²æ­¢æç¤ºæ³¨å…¥éƒ¨åˆ†ï¼‰*

```json
{
  "security": {
    "prompt_injection": {
      "protection_level": "high",
      "sanitize_input": true,
      "context_isolation": true,
      "command_validation": {
        "enabled": true,
        "strict_mode": true
      }
    }
  }
}
```

### è¾“å…¥éªŒè¯é…ç½®

```json
{
  "validation": {
    "input_filters": [
      {
        "name": "script_injection",
        "pattern": "<script[^>]*>",
        "action": "block"
      },
      {
        "name": "command_injection",
        "pattern": "[;&|`$]",
        "action": "escape"
      }
    ],
    "max_input_length": 10000
  }
}
```

## ä¼šè¯å®‰å…¨

### ä¼šè¯è¶…æ—¶é…ç½®

```json
{
  "session": {
    "timeout": 3600,
    "idle_timeout": 1800,
    "max_requests_per_session": 1000,
    "require_reauth": {
      "sensitive_operations": true,
      "time_interval": 7200
    }
  }
}
```

### å¤šå› ç´ è®¤è¯

```json
{
  "authentication": {
    "mfa": {
      "enabled": true,
      "methods": ["totp", "webauthn"],
      "required_for": [
        "production_access",
        "admin_operations"
      ]
    }
  }
}
```

## å›¢é˜Ÿå®‰å…¨é…ç½®

### è§’è‰²æƒé™ç®¡ç†

```json
{
  "rbac": {
    "roles": {
      "developer": {
        "permissions": [
          "read_code",
          "write_code",
          "run_tests"
        ]
      },
      "admin": {
        "permissions": [
          "read_code",
          "write_code",
          "deploy",
          "manage_users"
        ]
      }
    },
    "default_role": "developer"
  }
}
```

### ä»£ç å®¡æŸ¥å·¥ä½œæµ

```json
{
  "code_review": {
    "required_for": [
      "production_deploy",
      "config_changes",
      "security_fixes"
    ],
    "auto_review": {
      "security_scan": true,
      "dependency_check": true
    }
  }
}
```

## å®‰å…¨é’©å­é…ç½®

### é¢„æ‰§è¡Œå®‰å…¨æ£€æŸ¥

```javascript
// scripts/security-check.js
const crypto = require('crypto');

class SecurityChecker {
    constructor() {
        this.dangerousPatterns = [
            /rm\s+-rf/,
            /chmod\s+777/,
            />\s*\/dev\/null/,
            /\|\s*sh/,
            /\$\(/,
            /&&\s*rm/,
            /;\s*rm/
        ];

        this.sensitiveFiles = [
            /\.ssh\//,
            /\.aws\//,
            /\.env/,
            /.*\.key/,
            /.*\.pem/
        ];
    }

    checkCommand(command, args) {
        const fullCommand = `${command} ${args.join(' ')}`;

        // æ£€æŸ¥å±é™©æ¨¡å¼
        for (const pattern of this.dangerousPatterns) {
            if (pattern.test(fullCommand)) {
                console.log(`âŒ å±é™©å‘½ä»¤æ£€æµ‹: ${fullCommand}`);
                console.log(`åŒ¹é…æ¨¡å¼: ${pattern}`);
                return false;
            }
        }

        // æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶è®¿é—®
        for (const file of args) {
            for (const pattern of this.sensitiveFiles) {
                if (pattern.test(file)) {
                    console.log(`âŒ æ•æ„Ÿæ–‡ä»¶è®¿é—®: ${file}`);
                    return false;
                }
            }
        }

        console.log(`âœ… å‘½ä»¤å®‰å…¨æ£€æŸ¥é€šè¿‡: ${command}`);
        return true;
    }

    checkFileOperation(operation, filePath) {
        // æ£€æŸ¥æ–‡ä»¶æ“ä½œæƒé™
        if (filePath.includes('..')) {
            console.log('âŒ æ£€æµ‹åˆ°è·¯å¾„éå†æ”»å‡»');
            return false;
        }

        // æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
        for (const pattern of this.sensitiveFiles) {
            if (pattern.test(filePath)) {
                console.log(`âŒ å°è¯•è®¿é—®æ•æ„Ÿæ–‡ä»¶: ${filePath}`);
                return false;
            }
        }

        console.log(`âœ… æ–‡ä»¶æ“ä½œå®‰å…¨: ${operation} ${filePath}`);
        return true;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const checker = new SecurityChecker();
const command = process.argv[2];
const args = process.argv.slice(3);

if (!checker.checkCommand(command, args)) {
    process.exit(1);
}
```

### é…ç½®å®‰å…¨é’©å­

```json
{
  "hooks": {
    "pre_tool_use": "node scripts/security-check.js",
    "pre_file_edit": {
      "command": "node scripts/file-security-check.js",
      "require_confirmation": true
    },
    "post_api_call": {
      "command": "node scripts/audit-log.js",
      "async": true
    }
  }
}
```

## å®‰å…¨ç›‘æ§ä¸å‘Šè­¦

### å®æ—¶ç›‘æ§é…ç½®

```json
{
  "monitoring": {
    "security_events": {
      "enabled": true,
      "events": [
        "permission_denied",
        "suspicious_command",
        "multiple_failed_attempts",
        "unusual_file_access"
      ],
      "alerting": {
        "email": "security@company.com",
        "webhook": "https://alerts.company.com/webhook",
        "threshold": {
          "failed_attempts": 3,
          "time_window": 300
        }
      }
    }
  }
}
```

### å®¡è®¡æ—¥å¿—åˆ†æ

```javascript
// scripts/audit-analyzer.js
const fs = require('fs');
const path = require('path');

class AuditAnalyzer {
    constructor(logFile) {
        this.logFile = logFile;
    }

    analyze() {
        const logs = this.readLogs();
        const analysis = {
            total_events: logs.length,
            failed_attempts: 0,
            suspicious_activities: [],
            top_commands: {},
            file_accesses: {}
        };

        for (const log of logs) {
            // ç»Ÿè®¡å¤±è´¥å°è¯•
            if (log.event === 'permission_denied') {
                analysis.failed_attempts++;
            }

            // è¯†åˆ«å¯ç–‘æ´»åŠ¨
            if (this.isSuspicious(log)) {
                analysis.suspicious_activities.push(log);
            }

            // ç»Ÿè®¡å‘½ä»¤ä½¿ç”¨
            if (log.command) {
                analysis.top_commands[log.command] =
                    (analysis.top_commands[log.command] || 0) + 1;
            }

            // ç»Ÿè®¡æ–‡ä»¶è®¿é—®
            if (log.file_path) {
                analysis.file_accesses[log.file_path] =
                    (analysis.file_accesses[log.file_path] || 0) + 1;
            }
        }

        return analysis;
    }

    isSuspicious(log) {
        const suspiciousPatterns = [
            /rm.*-rf/,
            /chmod.*777/,
            /\.\./,
            /etc\/passwd/,
            /\.ssh/
        ];

        return suspiciousPatterns.some(pattern =>
            pattern.test(log.command || log.file_path || '')
        );
    }

    readLogs() {
        try {
            const content = fs.readFileSync(this.logFile, 'utf8');
            return content.split('\n')
                .filter(line => line.trim())
                .map(line => JSON.parse(line));
        } catch (error) {
            console.error('è¯»å–æ—¥å¿—å¤±è´¥:', error.message);
            return [];
        }
    }
}

// ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
const analyzer = new AuditAnalyzer('~/.claude/audit.log');
const report = analyzer.analyze();
console.log('å®‰å…¨å®¡è®¡æŠ¥å‘Š:', JSON.stringify(report, null, 2));
```

## å®‰å…¨æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•

### åŸºç¡€å®‰å…¨

- [ ] é…ç½®æœ€å°æƒé™åŸåˆ™
- [ ] å¯ç”¨æ²™ç›’éš”ç¦»
- [ ] è®¾ç½®æ•æ„Ÿæ–‡ä»¶ä¿æŠ¤
- [ ] é…ç½®ä¼šè¯è¶…æ—¶

### é«˜çº§å®‰å…¨

- [ ] å®æ–½RBACæƒé™æ§åˆ¶
- [ ] å¯ç”¨å®¡è®¡æ—¥å¿—
- [ ] é…ç½®å®‰å…¨é’©å­
- [ ] è®¾ç½®ç›‘æ§å‘Šè­¦

### å›¢é˜Ÿå®‰å…¨

- [ ] å»ºç«‹å®‰å…¨å®¡æŸ¥æµç¨‹
- [ ] å®šæœŸæƒé™å®¡è®¡
- [ ] å®‰å…¨åŸ¹è®­è®¡åˆ’
- [ ] åº”æ€¥å“åº”é¢„æ¡ˆ

## å¸¸è§å®‰å…¨é—®é¢˜è§£å†³æ–¹æ¡ˆ

### 1. æƒé™è¿‡å®½

**é—®é¢˜**ï¼šé…ç½®æƒé™è¿‡äºå®½æ¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
```json
{
  "permissions": {
    "default_deny": true,
    "allowed_dirs": ["./src"],  // æ˜ç¡®æŒ‡å®šå…è®¸ç›®å½•
    "allowed_commands": ["git", "npm"],  // æ˜ç¡®æŒ‡å®šå…è®¸å‘½ä»¤
    "require_confirmation": true  // éœ€è¦ç¡®è®¤æ‰€æœ‰æ“ä½œ
  }
}
```

### 2. æ•æ„Ÿä¿¡æ¯æ³„éœ²

**é—®é¢˜**ï¼šAPIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯æš´éœ²

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡
export ANTHROPIC_API_KEY="your_key"

# é…ç½®.gitignore
echo ".env" >> .gitignore
echo "*.key" >> .gitignore
echo "secrets/" >> .gitignore
```

### 3. æç¤ºæ³¨å…¥æ”»å‡»

**é—®é¢˜**ï¼šæ¶æ„è¾“å…¥å¹²æ‰°ç³»ç»Ÿè¡Œä¸º

**è§£å†³æ–¹æ¡ˆ**ï¼š
```json
{
  "security": {
    "input_validation": {
      "enabled": true,
      "sanitize_html": true,
      "escape_shell_chars": true,
      "max_length": 10000
    }
  }
}
```

### 4. æœªæˆæƒè®¿é—®

**é—®é¢˜**ï¼šæœªæˆæƒç”¨æˆ·è®¿é—®ç³»ç»Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```json
{
  "authentication": {
    "required": true,
    "mfa": true,
    "session_timeout": 1800,
    "ip_whitelist": ["192.168.1.0/24"]
  }
}
```

## å®‰å…¨åº”æ€¥å“åº”

### å®‰å…¨äº‹ä»¶å“åº”æµç¨‹

1. **æ£€æµ‹**ï¼šç›‘æ§ç³»ç»Ÿå‘Šè­¦
2. **è¯„ä¼°**ï¼šåˆ†æäº‹ä»¶å½±å“èŒƒå›´
3. **éš”ç¦»**ï¼šåˆ‡æ–­å—å½±å“ç³»ç»Ÿ
4. **ä¿®å¤**ï¼šä¿®è¡¥å®‰å…¨æ¼æ´
5. **æ¢å¤**ï¼šæ¢å¤ç³»ç»Ÿè¿è¡Œ
6. **æ€»ç»“**ï¼šæ”¹è¿›å®‰å…¨æªæ–½

### åº”æ€¥å“åº”è„šæœ¬

```bash
#!/bin/bash
# scripts/security-emergency.sh

echo "ğŸš¨ ClaudeCodeå®‰å…¨åº”æ€¥å“åº”"

# 1. ç«‹å³åœæ­¢æ‰€æœ‰æ“ä½œ
echo "åœæ­¢ClaudeCode..."
pkill -f claude

# 2. å¤‡ä»½å½“å‰é…ç½®
echo "å¤‡ä»½é…ç½®..."
cp -r ~/.claude ~/.claude.emergency.$(date +%Y%m%d_%H%M%S)

# 3. é‡ç½®ä¸ºæœ€å®‰å…¨é…ç½®
echo "é‡ç½®ä¸ºå®‰å…¨é…ç½®..."
cat > ~/.claude/settings.json << 'EOF'
{
  "permissions": {
    "allowed_dirs": [],
    "allowed_commands": [],
    "require_confirmation": true,
    "default_deny": true
  },
  "sandbox": {
    "enabled": true,
    "filesystem": {"boundaries": ["/tmp"]},
    "network": {"allowed_domains": []}
  },
  "audit": {
    "enabled": true,
    "log_level": "debug"
  }
}
EOF

# 4. ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
echo "ç”Ÿæˆå®‰å…¨æŠ¥å‘Š..."
ls -la ~/.claude/audit.log > security-report.txt

echo "âœ… åº”æ€¥å“åº”å®Œæˆï¼Œè¯·æ£€æŸ¥å®‰å…¨æŠ¥å‘Š"
```

## å®‰å…¨é…ç½®æ¨¡æ¿

### å¼€å‘ç¯å¢ƒå®‰å…¨é…ç½®

```json
{
  "permissions": {
    "allowed_dirs": ["./src", "./tests"],
    "allowed_commands": ["git", "npm", "node"],
    "require_confirmation": false
  },
  "sandbox": {
    "enabled": false
  },
  "audit": {
    "enabled": true,
    "log_level": "warn"
  }
}
```

### ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®

```json
{
  "permissions": {
    "default_deny": true,
    "allowed_dirs": ["./src"],
    "allowed_commands": ["git"],
    "require_confirmation": true
  },
  "sandbox": {
    "enabled": true,
    "network": {"allowed_domains": ["api.company.com"]}
  },
  "audit": {
    "enabled": true,
    "log_level": "info",
    "alerting": {
      "enabled": true,
      "webhook": "https://alerts.company.com"
    }
  },
  "authentication": {
    "mfa": true,
    "session_timeout": 1800
  }
}
```

é€šè¿‡åˆç†é…ç½®è¿™äº›å®‰å…¨æªæ–½ï¼Œå¯ä»¥æ˜¾è‘—æå‡ClaudeCodeä½¿ç”¨çš„å®‰å…¨æ€§ï¼Œä¿æŠ¤æ‚¨çš„ä»£ç å’Œæ•°æ®å®‰å…¨ã€‚