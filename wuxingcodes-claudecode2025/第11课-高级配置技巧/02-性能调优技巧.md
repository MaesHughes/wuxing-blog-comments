# 性能调优技巧

## 概述

ClaudeCode的性能优化主要从以下几个方面入手：模型选择、缓存策略、并发处理和资源管理。通过合理配置，可以显著提升响应速度和开发效率。

## 模型选择优化

### 智能模型切换策略

使用 `opusplan` 模式实现自动切换：

```json
{
  "model": "opusplan",
  "model_strategy": {
    "planning": "opus",
    "implementation": "sonnet",
    "simple_tasks": "haiku"
  },
  "context": {
    "auto_switch_threshold": {
      "complexity": 0.7,
      "token_count": 1000
    }
  }
}
```

*（引用来源：模型配置文档 - opusplan模式）*

### 不同场景的模型选择

| 场景 | 推荐模型 | 说明 |
|------|----------|------|
| 日常编码 | sonnet | 平衡速度和质量 |
| 架构设计 | opus | 深度分析能力 |
| 简单修改 | haiku | 快速响应 |
| 代码审查 | opus | 细致分析 |
| 文档生成 | sonnet | 良好的写作能力 |

### 动态模型配置

```json
{
  "adaptive_model": {
    "enabled": true,
    "rules": [
      {
        "condition": "file.type == 'test'",
        "model": "haiku"
      },
      {
        "condition": "task.complexity > 0.8",
        "model": "opus"
      },
      {
        "condition": "context.token_count > 50000",
        "model": "sonnet[1m]"
      }
    ]
  }
}
```

## 提示缓存优化

### 启用提示缓存

```bash
# 确保缓存启用（默认）
export DISABLE_PROMPT_CACHING=0

# 按模型配置缓存
export DISABLE_PROMPT_CACHING_HAIKU=1  # Haiku不需要缓存
export DISABLE_PROMPT_CACHING_SONNET=0
export DISABLE_PROMPT_CACHING_OPUS=0
```

*（引用来源：模型配置文档 - 提示缓存配置）*

### 缓存策略配置

```json
{
  "performance": {
    "prompt_caching": {
      "enabled": true,
      "strategy": "aggressive",
      "max_cache_size": "1GB",
      "cache_ttl": 3600
    }
  }
}
```

### 缓存效果监控

```bash
# 查看缓存统计
claude "/stats cache"

# 手动管理缓存
claude "/cache clear"     # 清空缓存
claude "/cache warm"      # 预热缓存
```

## 上下文管理

### 自动压缩配置

```json
{
  "performance": {
    "auto_compact": {
      "enabled": true,
      "threshold": 0.8,          # 80%上下文使用率时触发
      "interval": 300,           # 每5分钟检查一次
      "strategy": "smart"        # 智能压缩保留重要信息
    }
  }
}
```

*（引用来源：故障排除文档 - 性能优化部分）*

### 上下文窗口优化

```bash
# 使用扩展上下文模型
claude /model sonnet[1m]

# 或在配置中设置
{
  "model": "sonnet[1m]",
  "context": {
    "max_tokens": 1000000,
    "compression_ratio": 0.3
  }
}
```

### 手动上下文管理

```bash
# 清理当前上下文
claude /compact

# 保留特定信息
claude "/compact keep:config,auth,patterns"

# 查看上下文使用情况
claude "/context info"
```

## 并发处理优化

### 并行请求配置

```json
{
  "performance": {
    "parallel_requests": true,
    "max_concurrent": 3,
    "queue_size": 10,
    "timeout": 30000
  }
}
```

### 批处理优化

```json
{
  "batch_processing": {
    "enabled": true,
    "batch_size": 5,
    "delay_between_batches": 100,
    "merge_similar_requests": true
  }
}
```

## 搜索性能优化

### 安装ripgrep提升搜索速度

```bash
# macOS
brew install ripgrep

# Ubuntu/Debian
sudo apt install ripgrep

# Windows (winget)
winget install BurntSushi.ripgrep.MSVC

# 配置使用ripgrep
export USE_BUILTIN_RIPGREP=0
```

*（引用来源：故障排除文档 - 搜索和发现问题）*

### 搜索优化配置

```json
{
  "search": {
    "engine": "ripgrep",
    "options": [
      "--max-columns=150",
      "--max-filesize=10M",
      "--type-add='web:*.{html,css,js,ts,tsx,jsx}'"
    ],
    "exclude_patterns": [
      "node_modules/*",
      "*.min.js",
      "dist/*"
    ]
  }
}
```

## 网络优化

### 请求超时配置

```json
{
  "network": {
    "timeout": 30000,
    "retry_attempts": 3,
    "retry_delay": 1000,
    "keep_alive": true
  }
}
```

### 代理配置

```bash
# HTTP代理
export HTTP_PROXY=http://proxy.company.com:8080
export HTTPS_PROXY=https://proxy.company.com:8080

# 绕过代理的域名
export NO_PROXY=localhost,127.0.0.1,.company.com
```

## 内存优化

### 内存使用监控

```bash
# 监控内存使用
claude /memory

# 设置内存限制
export CLAUDE_MEMORY_LIMIT=2048  # MB
```

### 内存管理配置

```json
{
  "memory": {
    "max_usage": "2GB",
    "gc_threshold": 0.8,
    "swap_threshold": 0.9
  }
}
```

## 性能监控

### 性能指标收集

```json
{
  "monitoring": {
    "enabled": true,
    "metrics": [
      "response_time",
      "token_usage",
      "cache_hit_rate",
      "error_rate"
    ],
    "export_format": "prometheus"
  }
}
```

### 性能分析工具

创建性能分析脚本：

```javascript
// scripts/perf-analyzer.js
const fs = require('fs');
const path = require('path');

class PerformanceAnalyzer {
    constructor() {
        this.metrics = {
            requestCount: 0,
            totalTokens: 0,
            cacheHits: 0,
            errors: 0
        };
    }

    recordRequest(tokens, cached, error) {
        this.metrics.requestCount++;
        this.metrics.totalTokens += tokens;
        if (cached) this.metrics.cacheHits++;
        if (error) this.metrics.errors++;
    }

    getReport() {
        const avgTokens = this.metrics.totalTokens / this.metrics.requestCount;
        const cacheHitRate = (this.metrics.cacheHits / this.metrics.requestCount) * 100;
        const errorRate = (this.metrics.errors / this.metrics.requestCount) * 100;

        return {
            average_tokens_per_request: avgTokens.toFixed(2),
            cache_hit_rate: `${cacheHitRate.toFixed(2)}%`,
            error_rate: `${errorRate.toFixed(2)}%`,
            total_requests: this.metrics.requestCount
        };
    }
}
```

## 性能优化检查清单

### 基础优化

- [ ] 选择合适的模型
- [ ] 启用提示缓存
- [ ] 配置自动压缩
- [ ] 安装ripgrep

### 高级优化

- [ ] 实现智能模型切换
- [ ] 配置并行处理
- [ ] 优化搜索参数
- [ ] 设置内存限制

### 监控优化

- [ ] 启用性能监控
- [ ] 定期查看指标
- [ ] 分析瓶颈
- [ ] 持续调优

## 常见性能问题及解决方案

### 1. 响应速度慢

**症状**：请求响应时间过长

**解决方案**：
```bash
# 检查网络连接
ping api.anthropic.com

# 使用更快的模型
claude /model haiku

# 启用缓存
export DISABLE_PROMPT_CACHING=0

# 压缩上下文
claude /compact
```

### 2. 内存占用高

**症状**：长时间运行后内存使用持续增长

**解决方案**：
```json
{
  "performance": {
    "auto_compact": {
      "enabled": true,
      "threshold": 0.6,  // 降低阈值
      "interval": 180    // 更频繁检查
    }
  }
}
```

### 3. 搜索性能差

**症状**：文件搜索非常缓慢

**解决方案**：
```bash
# 确认ripgrep已安装
which rg

# 设置环境变量
export USE_BUILTIN_RIPGREP=0

# 优化搜索范围
claude "在src目录搜索xxx"  # 而不是全局搜索
```

### 4. 频繁超时

**症状**：请求经常超时失败

**解决方案**：
```json
{
  "network": {
    "timeout": 60000,        // 增加超时时间
    "retry_attempts": 5,     // 增加重试次数
    "retry_delay": 2000      // 延长重试间隔
  }
}
```

## 性能基准测试

### 基准测试脚本

```bash
#!/bin/bash
# scripts/perf-benchmark.sh

echo "🚀 ClaudeCode性能基准测试"

# 测试1：简单响应时间
echo "测试1：简单响应时间"
start_time=$(date +%s%N)
claude "Hello" > /dev/null
end_time=$(date +%s%N)
response_time=$(($((end_time - start_time)) / 1000000))
echo "响应时间: ${response_time}ms"

# 测试2：代码生成性能
echo "测试2：代码生成性能"
start_time=$(date +%s%N)
claude "创建一个React组件" > /dev/null
end_time=$(date +%s%N)
code_gen_time=$(($((end_time - start_time)) / 1000000))
echo "代码生成时间: ${code_gen_time}ms"

# 测试3：大文件处理
echo "测试3：大文件处理"
echo "Creating large test file..."
for i in {1..1000}; do echo "Line $i with some content"; done > large-file.txt

start_time=$(date +%s%N)
claude "分析large-file.txt中的重复内容" > /dev/null
end_time=$(date +%s%N)
large_file_time=$(($((end_time - start_time)) / 1000000))
echo "大文件处理时间: ${large_file_time}ms"

# 清理
rm -f large-file.txt

echo "✅ 基准测试完成"
```

运行基准测试：

```bash
chmod +x scripts/perf-benchmark.sh
./scripts/perf-benchmark.sh
```

## 性能优化建议

### 日常使用

1. **定期清理**：每天结束时使用 `/compact` 清理上下文
2. **模型选择**：根据任务复杂度选择合适模型
3. **批量操作**：合并相似请求减少API调用

### 项目配置

1. **智能缓存**：为重复任务启用缓存
2. **搜索优化**：限定搜索范围提高速度
3. **权限精简**：减少不必要的权限检查

### 长期维护

1. **监控指标**：定期查看性能报告
2. **配置调优**：根据使用模式调整配置
3. **版本更新**：保持ClaudeCode为最新版本