# 多项目环境配置

## 概述

在实际开发中，我们经常需要在多个不同类型的项目间切换。ClaudeCode提供了灵活的配置方案，让您可以为每个项目设置专门的配置。

## 项目级配置

### 配置文件位置

ClaudeCode按以下优先级查找配置文件：

1. `./.clauderc` - 项目根目录（最高优先级）
2. `./settings.json` - 项目根目录
3. `~/.claude/settings.json` - 用户全局配置
4. 默认配置

### 基础配置模板

```json
{
  "permissions": {
    "allowed_dirs": ["./src", "./tests", "./docs"],
    "denied_dirs": ["~/.ssh", "/etc", "~/.config"],
    "allowed_commands": ["git", "npm", "node", "python", "pytest"],
    "denied_commands": ["sudo", "su", "rm -rf"],
    "require_confirmation": true
  },
  "model": "sonnet",
  "context": {
    "framework": "React",
    "language": "TypeScript",
    "package_manager": "npm"
  }
}
```

## 不同技术栈配置

### React项目配置

创建 `.clauderc` 文件：

```json
{
  "permissions": {
    "allowed_dirs": ["./src", "./public", "./tests", "./docs"],
    "allowed_commands": ["npm", "yarn", "pnpm", "node", "npx", "git"],
    "require_confirmation": ["npm run build", "npm publish"]
  },
  "model": "sonnet",
  "context": {
    "framework": "React",
    "language": "TypeScript",
    "build_tool": "Vite",
    "testing_framework": "Jest"
  },
  "hooks": {
    "pre_edit": "npm run lint",
    "post_edit": "npm run type-check"
  }
}
```

### Python项目配置

```json
{
  "permissions": {
    "allowed_dirs": ["./src", "./tests", "./docs", "./config"],
    "allowed_commands": ["python", "pip", "pytest", "django-admin", "flask"],
    "require_confirmation": ["pip install", "python manage.py migrate"]
  },
  "model": "opus",
  "context": {
    "framework": "Django",
    "language": "Python",
    "database": "PostgreSQL",
    "orm": "SQLAlchemy"
  },
  "hooks": {
    "pre_tool_use": "python scripts/validate.py"
  }
}
```

### Node.js后端项目配置

```json
{
  "permissions": {
    "allowed_dirs": ["./src", "./tests", "./config", "./migrations"],
    "allowed_commands": ["node", "npm", "yarn", "npx", "pm2"],
    "denied_commands": ["rm -rf ./node_modules"],
    "require_confirmation": ["npm install", "npm run deploy"]
  },
  "model": "sonnet",
  "context": {
    "framework": "Express",
    "language": "TypeScript",
    "database": "MongoDB",
    "auth": "JWT"
  }
}
```

## 环境变量配置

### 使用.env文件

在项目根目录创建 `.env`：

```bash
# ClaudeCode配置
ANTHROPIC_MODEL=sonnet
CLAUDE_CODE_DEBUG=0
DISABLE_PROMPT_CACHING=0

# 项目特定配置
NODE_ENV=development
DATABASE_URL=mongodb://localhost:27017/myapp
```

### 环境特定配置

创建不同环境的配置文件：

**开发环境 (.env.development)**：
```bash
ANTHROPIC_MODEL=sonnet
CLAUDE_CODE_DEBUG=1
ALLOWED_COMMANDS="git,npm,node,pytest"
```

**生产环境 (.env.production)**：
```bash
ANTHROPIC_MODEL=opus
CLAUDE_CODE_DEBUG=0
REQUIRE_CONFIRMATION=true
AUDIT_LOGGING=true
```

加载环境配置：

```bash
# 开发环境
source .env.development

# 生产环境
source .env.production
```

## 团队协作配置

### 共享配置文件

在项目根目录创建 `CLAUDE.md`：

```markdown
# ClaudeCode项目配置

## 项目信息
- **名称**: 我的Web应用
- **类型**: 全栈Web应用
- **技术栈**: React + Node.js + MongoDB

## 开发规范
- 前端使用TypeScript严格模式
- 后端遵循RESTful API设计
- 测试覆盖率要求 >80%
- 代码风格：ESLint + Prettier

## ClaudeCode使用指南

### 模型选择
- **日常开发**: sonnet（平衡性能和质量）
- **复杂架构**: opus（深度分析和设计）
- **简单修改**: haiku（快速响应）

### 常用命令
```bash
# 开发
npm run dev          # 启动开发服务器
npm run test         # 运行测试
npm run lint         # 代码检查

# 部署
npm run build        # 构建生产版本
npm run deploy       # 部署到服务器
```

### 注意事项
- 不要修改 `node_modules` 目录
- 所有API调用需要错误处理
- 新功能必须包含测试
- 敏感信息使用环境变量
```

### 权限配置共享

创建 `team-settings.json`：

```json
{
  "permissions": {
    "allowed_dirs": [
      "./src",
      "./tests",
      "./docs",
      "./scripts"
    ],
    "allowed_commands": [
      "git",
      "npm",
      "node",
      "npx",
      "pytest",
      "eslint",
      "prettier"
    ],
    "require_confirmation": [
      "npm publish",
      "npm run deploy",
      "git push origin main"
    ]
  },
  "model": "sonnet",
  "performance": {
    "prompt_caching": true,
    "auto_compact": true
  },
  "security": {
    "audit_logging": true,
    "session_timeout": 3600
  }
}
```

团队成员使用：

```bash
# 复制团队配置
cp team-settings.json ~/.claude/settings.json

# 添加个人覆盖
echo '"model": "opus"' >> ~/.claude/settings.json
```

## 配置切换策略

### 项目切换脚本

创建 `switch-project.sh`：

```bash
#!/bin/bash

PROJECT_NAME=$1
CONFIG_DIR="$HOME/.claude/project-configs"

# 使用配置
if [ -f "$CONFIG_DIR/$PROJECT_NAME.json" ]; then
    cp "$CONFIG_DIR/$PROJECT_NAME.json" ~/.claude/settings.json
    echo "✅ 已切换到项目: $PROJECT_NAME"
else
    echo "❌ 项目配置不存在: $PROJECT_NAME"
fi

# 验证配置
claude /status
```

### 配置管理工具

创建 `manage-config.js`：

```javascript
#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

class ConfigManager {
    constructor() {
        this.configDir = path.join(process.env.HOME, '.claude');
        this.projectDir = path.join(this.configDir, 'project-configs');
    }

    // 保存项目配置
    saveProject(name, config) {
        if (!fs.existsSync(this.projectDir)) {
            fs.mkdirSync(this.projectDir, { recursive: true });
        }

        const filePath = path.join(this.projectDir, `${name}.json`);
        fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
        console.log(`✅ 配置已保存: ${name}`);
    }

    // 加载项目配置
    loadProject(name) {
        const filePath = path.join(this.projectDir, `${name}.json`);

        if (fs.existsSync(filePath)) {
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));
            fs.writeFileSync(
                path.join(this.configDir, 'settings.json'),
                JSON.stringify(config, null, 2)
            );
            console.log(`✅ 已加载配置: ${name}`);
        } else {
            console.log(`❌ 配置不存在: ${name}`);
        }
    }

    // 列出所有配置
    listConfigs() {
        if (fs.existsSync(this.projectDir)) {
            const files = fs.readdirSync(this.projectDir);
            const configs = files
                .filter(f => f.endsWith('.json'))
                .map(f => f.replace('.json', ''));
            console.log('可用配置:');
            configs.forEach(c => console.log(`  - ${c}`));
        }
    }
}

// 使用示例
const manager = new ConfigManager();
const command = process.argv[2];
const projectName = process.argv[3];

switch (command) {
    case 'save':
        // 从当前项目保存配置
        const currentConfig = require(path.join(process.cwd(), '.clauderc'));
        manager.saveProject(projectName, currentConfig);
        break;

    case 'load':
        manager.loadProject(projectName);
        break;

    case 'list':
        manager.listConfigs();
        break;

    default:
        console.log('用法:');
        console.log('  node manage-config.js save <name>');
        console.log('  node manage-config.js load <name>');
        console.log('  node manage-config.js list');
}
```

## 最佳实践

### 1. 配置分离

- **通用配置**: 放在全局 `~/.claude/settings.json`
- **项目特定**: 放在项目根目录 `.clauderc`
- **敏感信息**: 使用环境变量

### 2. 版本控制

```bash
# 提交配置模板
git add settings.json.template
git add CLAUDE.md

# 忽略个人配置
echo ".clauderc.local" >> .gitignore
echo ".env.local" >> .gitignore
```

### 3. 团队协作

- 使用统一的配置模板
- 定期同步配置更新
- 建立配置审查机制

### 4. 安全考虑

- 不要提交API密钥
- 使用最小权限原则
- 定期审查权限设置

## 故障排除

### 常见问题

1. **配置不生效**
   ```bash
   # 检查配置位置
   ls -la ~/.claude/settings.json
   ls -la ./.clauderc

   # 验证JSON格式
   cat ~/.claude/settings.json | python -m json.tool
   ```

2. **权限设置错误**
   ```bash
   # 重置权限
   claude /permissions

   # 使用默认配置
   rm ~/.claude/settings.json
   claude
   ```

3. **模型切换失败**
   ```bash
   # 检查模型可用性
   claude /status

   # 强制切换模型
   claude /model sonnet
   ```

### 调试技巧

启用调试模式：

```bash
export CLAUDE_DEBUG=1
claude
```

查看详细日志，帮助定位问题。